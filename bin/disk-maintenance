#!/usr/bin/env bash
set -euo pipefail

MODE="${1:-}"

CONFIG_FILE="/etc/disk-maintenance.conf"
STATE_DIR="/var/lib/disk-maintenance"
HISTORY_FILE="$STATE_DIR/history.jsonl"

# Defaults (can be overridden by config)
CLEANUP_THRESHOLD_PCT=85
EMERGENCY_THRESHOLD_PCT=95
EMERGENCY_MIN_FREE_BYTES=$((1024*1024*1024))
JOURNAL_VACUUM_CLEANUP="200M"
JOURNAL_VACUUM_EMERGENCY="50M"
COREDUMP_RETENTION_DAYS=14
SNAP_CLEANUP_ENABLED=1
SNAP_REFRESH_RETAIN=2
DOCKER_PRUNE_ENABLED=1
DOCKER_VOLUME_PRUNE_ENABLED=0
AGENT_CLI="codex"     # none|codex|opencode
AGENT_OUTPUT="json"   # json|plain

load_config() {
  if [[ -f "$CONFIG_FILE" ]]; then
    # shellcheck disable=SC1090
    source "$CONFIG_FILE"
  fi
}

root_usage_pct() {
  df -P / | awk 'NR==2{gsub(/%/,"",$5); print $5}'
}

root_free_bytes() {
  # df -B1 prints available bytes in column 4
  df -PB1 / | awk 'NR==2{print $4}'
}

ensure_state_dir() {
  sudo install -d -m 0755 "$STATE_DIR"
}

json_escape() {
  python3 - <<'PY'
import json,sys
print(json.dumps(sys.stdin.read()))
PY
}

emit_history_record() {
  ensure_state_dir
  local ts usage free
  ts="$(date -Is)"
  usage="$(root_usage_pct)"
  free="$(root_free_bytes)"

  # Keep it simple: store some key metrics + short df output.
  local df_out
  df_out="$(df -hT / | tail -n +1)"

  printf '{"ts":%s,"mode":%s,"root_usage_pct":%s,"root_free_bytes":%s,"df":%s}\n' \
    "$(printf '%s' "$ts" | json_escape)" \
    "$(printf '%s' "$MODE" | json_escape)" \
    "$(printf '%s' "$usage" | json_escape)" \
    "$(printf '%s' "$free" | json_escape)" \
    "$(printf '%s' "$df_out" | json_escape)" \
    | sudo tee -a "$HISTORY_FILE" >/dev/null
}

report_top() {
  echo "[disk-maintenance] df -hT /"
  df -hT /

  echo
  echo "[disk-maintenance] top dirs (bounded)"
  sudo du -xh --max-depth=2 /var/cache /var/log /var/lib/docker 2>/dev/null | sort -h | tail -n 40 || true
}

vacuum_journal() {
  local target="$1"
  if command -v journalctl >/dev/null 2>&1; then
    sudo journalctl --vacuum-size="$target" || true
  fi
}

cleanup_pacman_cache() {
  if command -v paccache >/dev/null 2>&1; then
    sudo paccache -rk1 || true
  fi
}

cleanup_coredumps() {
  local days="$1"
  local dir="/var/lib/systemd/coredump"
  [[ -d "$dir" ]] || return 0

  # Conservative: delete only older than N days.
  sudo find "$dir" -type f -mtime "+$days" -print -delete 2>/dev/null || true
}

snap_cleanup_disabled() {
  [[ "${SNAP_CLEANUP_ENABLED:-0}" -eq 1 ]] || return 0
  command -v snap >/dev/null 2>&1 || return 0

  # Set retention (best-effort)
  sudo snap set system "refresh.retain=${SNAP_REFRESH_RETAIN}" 2>/dev/null || true

  # Remove disabled revisions
  # Format: Name Version Rev Tracking Publisher Notes
  # Notes includes "disabled".
  while read -r name _version rev _tracking _publisher notes; do
    if [[ "$notes" == *disabled* ]]; then
      sudo snap remove "$name" --revision "$rev" || true
    fi
  done < <(snap list --all 2>/dev/null | awk 'NR>1{print $1,$2,$3,$4,$5,$6}')
}

docker_prune() {
  [[ "${DOCKER_PRUNE_ENABLED:-0}" -eq 1 ]] || return 0
  command -v docker >/dev/null 2>&1 || return 0

  # Bounded: no -a
  sudo docker system prune -f || true

  if [[ "${DOCKER_VOLUME_PRUNE_ENABLED:-0}" -eq 1 ]]; then
    sudo docker volume prune -f || true
  fi
}

agent_triage() {
  local usage free
  usage="$(root_usage_pct)"
  free="$(root_free_bytes)"

  if [[ "$AGENT_CLI" == "none" ]]; then
    return 0
  fi

  if [[ "$AGENT_CLI" == "codex" ]] && command -v codex >/dev/null 2>&1; then
    local prompt
    prompt="You are running in triage mode. Provide next safe disk-space recovery steps.\n\nRoot usage: ${usage}%\nRoot free bytes: ${free}\n\nRecent disk-maintenance report follows:\n$(report_top)"

    if [[ "$AGENT_OUTPUT" == "json" ]]; then
      printf '%s' "$prompt" | codex exec --skip-git-repo-check --sandbox read-only --json -o --color never - 2>/dev/null || true
    else
      printf '%s' "$prompt" | codex exec --skip-git-repo-check --sandbox read-only --color never - 2>/dev/null || true
    fi
    return 0
  fi

  if [[ "$AGENT_CLI" == "opencode" ]] && command -v opencode >/dev/null 2>&1; then
    local msg
    msg="Triage mode: suggest next safe disk-space recovery steps. Root usage=${usage}%. Root free bytes=${free}."

    if [[ "$AGENT_OUTPUT" == "json" ]]; then
      opencode run --format json "$msg" 2>/dev/null || true
    else
      opencode run "$msg" 2>/dev/null || true
    fi
    return 0
  fi

  return 0
}

should_cleanup() {
  local usage
  usage="$(root_usage_pct)"
  [[ "$usage" -ge "${CLEANUP_THRESHOLD_PCT}" ]]
}

should_emergency() {
  local usage free
  usage="$(root_usage_pct)"
  free="$(root_free_bytes)"

  if [[ "$usage" -ge "${EMERGENCY_THRESHOLD_PCT}" ]]; then
    return 0
  fi
  if [[ "$free" -lt "${EMERGENCY_MIN_FREE_BYTES}" ]]; then
    return 0
  fi
  return 1
}

case "$MODE" in
  report)
    load_config
    emit_history_record
    report_top
    ;;

  cleanup)
    load_config
    emit_history_record
    if ! should_cleanup; then
      echo "[disk-maintenance] below threshold; report-only"
      report_top
      exit 0
    fi

    cleanup_pacman_cache
    vacuum_journal "$JOURNAL_VACUUM_CLEANUP"
    cleanup_coredumps "$COREDUMP_RETENTION_DAYS"
    snap_cleanup_disabled
    docker_prune

    emit_history_record
    report_top
    ;;

  emergency)
    load_config
    emit_history_record
    if ! should_emergency; then
      echo "[disk-maintenance] emergency conditions not met; report-only"
      report_top
      exit 0
    fi

    cleanup_pacman_cache
    vacuum_journal "$JOURNAL_VACUUM_EMERGENCY"
    snap_cleanup_disabled
    docker_prune

    echo
    echo "[disk-maintenance] agent triage report (best-effort)"
    agent_triage || true

    emit_history_record
    report_top
    ;;

  *)
    echo "Usage: $0 {report|cleanup|emergency}" >&2
    exit 2
    ;;
esac
